var Reengage=Reengage||{};Reengage.Capture={cookieName:"__reengageInfo",construct:function(e){for(var n=document.body.querySelectorAll("form"),a=0;a<n.length;a+=1)n[a].addEventListener("submit",Reengage.Capture.onSubmit)},onSubmit:function(e){for(var n=Reengage.Capture,a=e.target.getElementsByTagName("input"),o={},g=0;g<a.length;g+=1){var t=a[g];if("password"==t.getAttribute("type"))continue;if(null==o.email&&-1!=t.value.search(/(.)+@(.)+/i)&&(o.email=t.value),Reengage.async.fields[t.name]){if("radio"==t.type&&!t.checked)continue;if("checkbox"==t.type){o[Reengage.async.fields[t.name]]=t.checked;continue}o[Reengage.async.fields[t.name]]=t.value}}if(n.log(JSON.stringify(o)),null==o.email)return;Reengage.Capture._setCookie(Reengage.Capture.cookieName,JSON.stringify(o))},_setCookie:function(e,n){document.cookie=e+"="+n+";path=/"},_createFunctionWithTimeout:function(e,n){var a=!1;function o(){a||(a=!0,e())}return setTimeout(o,n||1e3),o},log:function(e){Reengage.Core.debug&&null!=console&&console.log("DEBUG: "+e)}},window.addEventListener("load",function(){Reengage.Capture.construct()}),Reengage.Core={isReengageExecutedAfterGaSendPageView:null,debug:!0,REENGAGE_HOST:"https://public.reengage.io",ID_COOKIE_EXPIRATION:365,emailCookieName:"__reengageInfo",idCookieName:"__reengageId",fieldHashMap:{a:"a",jid:"jid",gjid:"gjid",cid:"cid",tid:"tid",_gid:"_gid",z:"z"},fieldsIgnoredFromPageView:{send:"a",userId:"a",dimension1:"a"},isRequiredCookiesFound:function(){var e=Reengage.Core;if(e.getCookie(e.idCookieName))return!0;if(e.getCookie(e.emailCookieName))return!0;return e.log("idCookie and emailCookie not found"),!1},gaSendPageViewDetector:function(){if("function"!=typeof ga)return void Reengage.Core.log("Reengage positionned before GA");if(void 0===ga.q)return Reengage.Core.log("GA full function already loaded with command queue executed"),void(Reengage.Core.isReengageExecutedAfterGaSendPageView=!0);Reengage.Core.log("GA full function NOT loaded yet, queue NOT reset (GA script too long to fetch ?)"),Reengage.async=Reengage.async||{},Reengage.async.gaq=Reengage.async.gaq||ga.q;for(var e=0;e<Reengage.async.gaq.length;e+=1)if("send"===Reengage.async.gaq[e][0]&&"pageview"===Reengage.async.gaq[e][1])return Reengage.Core.isReengageExecutedAfterGaSendPageView=!0,void Reengage.Core.log("Reengage executed after sendPageView")},cloneEventRequests:function(e){for(var n={},a=decodeURIComponent(e).split("&"),o=[],g=0;g<a.length;g+=1){if(o=a[g].split("="),this.fieldHashMap[o[0]])continue;n["&"+o[0]]=o[1]}return n},spyFunc:function(e){var n=Reengage.Core;if(!n.getCookie(n.idCookieName))return;var a=e.get("hitPayload"),o=e.get("hitType");"pageview"==o&&(n.log("Spy pageview"),ga("__Reengage.set",n.cloneEventRequests(a))),"event"==o&&(n.log("Spy event"),ga("__Reengage.set",n.cloneEventRequests(a))),n.setReengageFields(),ga("__Reengage.send",o)},sendReengagePageViewIfRequired:function(){var e=Reengage.Core;if(myGaq=Reengage.async.gaq,!e.isReengageExecutedAfterGaSendPageView)return;if(null!=myGaq)for(var n=0;n<myGaq.length;n+=1){if(null!=e.fieldsIgnoredFromPageView[myGaq[n][0]])continue;ga("__Reengage."+myGaq[n][0],myGaq[n][1],myGaq[n][2])}e.setReengageFields(),ga("__Reengage.send","pageview"),e.log("SendPageView by Reengage instead of clientGA")},setReengageFields:function(){var e=Reengage.Core.getCookie(Reengage.Core.idCookieName);ga("__Reengage.set","dimension1",e),ga("__Reengage.set","userId",e),ga("__Reengage.set","dimension2",Reengage.async.appName)},generateIdCookie:function(){var e,n;if((e=Reengage.Core).getCookie(e.idCookieName))return void e.log("IdCookie found, generateIdCookie stopped");var a=e.getCookie(e.emailCookieName);e.log("info found in cookie are: "+a),n=function(n){e.log("Response from /identify : "+n);var a=JSON.parse(n);e.setCookie(e.idCookieName,a.token,e.ID_COOKIE_EXPIRATION),e.log("Set JS cookies with idCookie: "+e.getCookie(e.idCookieName))},(a=JSON.parse(a)).app=Reengage.async.appName,e._xhrRequest({url:e.REENGAGE_HOST+"/identify",method:"POST",body:a},n)},_xhrRequest:function(e,n){var a,o;o=Reengage.Core,(a=new XMLHttpRequest).onreadystatechange=function(){4==this.readyState&&500!=this.status&&n(a.responseText)},a.open(e.method,e.url,!0),a.setRequestHeader("Content-Type","application/json"),a.send(JSON.stringify(e.body)),o.log("Request sent to "+e.url)},getCookie:function(e){if(!e)return document.cookie;var n=document.cookie.match(new RegExp(e+"=([^;]+)"));if(n)return n[1]},setCookie:function(e,n,a){var o,g;a=void 0!==a?a:1,(g=new Date).setTime(g.getTime()+24*a*60*60*1e3),o=e+"="+n+";path=/",a&&(o=o+";expires="+g.toUTCString()),document.cookie=o},log:function(e){Reengage.Core.debug&&null!=console&&console.log("DEBUG: "+e)}},Reengage.Old={loadAnalyticsDotJs:function(){Reengage.Core.log("WARNING: GA script loaded by reengage instead of website."),function(e,n,a,o,g,t,i){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,t=n.createElement(a),i=n.getElementsByTagName(a)[0],t.async=1,t.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(t,i)}(window,document,"script",0,"ga")},attachTracker:function(){},loadNewTrackerIfRequired:function(){"undefined"==typeof ga&&(Reengage.Old.attachTracker(),Reengage.Old.loadAnalyticsDotJs(),Reengage.Core.isReengageExecutedAfterGaSendPageView=!0)}};var callGivenFunctionAfterGaRequestSent=function(e,n){var a=e.get("sendHitTask");e.set("sendHitTask",function(e){a(e),n(e)}),Reengage.Core.log("Spy on GA requests set")};Reengage.Core.gaSendPageViewDetector(),Reengage.Core.isRequiredCookiesFound()&&(Reengage.Old.loadNewTrackerIfRequired(),ga(function(e){if(!Reengage.async.appName||!Reengage.async.id)return void Reengage.Core.log("appName / id should be given as async param, execution stopped");ga("create","UA-"+Reengage.async.id,"auto","__Reengage"),Reengage.Core.generateIdCookie(),Reengage.Core.sendReengagePageViewIfRequired(),callGivenFunctionAfterGaRequestSent(e,Reengage.Core.spyFunc)}));
